---
import type { CollectionEntry } from 'astro:content';
import Base from './Base.astro';

type Props = CollectionEntry<'page'>['data'] & {
	content?: string;
};

const { title } = Astro.props;

// GitHub API 配置
const GITHUB_REPO = 'Fanxaio/fanxiao';
const ISSUE_NUMBER = '1';
---

<Base title={title} description={title}>
	<p></p>
	<h2>–</h2>
	<h1>{title}</h1>
	<div class='post-content content'>
		<slot />

		<div id='shuoshuo'>
			<ul id='shuoshuo-list'>
				<li class='empty'>正在加载碎碎念...</li>
			</ul>
		</div>
	</div>
</Base>

<script is:inline src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script is:inline define:vars={{ GITHUB_REPO, ISSUE_NUMBER }}>
	async function loadShuoshuo() {
		const listEl = document.getElementById('shuoshuo-list');
		if (!listEl || !GITHUB_REPO || !ISSUE_NUMBER) return;

		const API_URL = `https://api.github.com/repos/${GITHUB_REPO}/issues/${ISSUE_NUMBER}/comments`;

		try {
			const response = await fetch(API_URL, {
				headers: {
					'Accept': 'application/vnd.github.v3+json',
				},
			});

			if (!response.ok) {
				throw new Error(`GitHub API 错误: ${response.status}`);
			}

			const comments = await response.json();
			comments.reverse();

			if (comments.length === 0) {
				listEl.innerHTML = '<li class="empty">暂无说说</li>';
				return;
			}

			listEl.innerHTML = comments.map(comment => {
				const date = new Date(comment.created_at).toLocaleDateString('zh-CN', {
					year: 'numeric',
					month: '2-digit',
					day: '2-digit',
				});
				// 使用 marked 解析 Markdown
				const content = window.marked ? window.marked.parse(comment.body) : comment.body;
				
				return `
					<li class="comment">
						<div class="meta">
							<span class="date">${date}</span>
						</div>
						<div class="body">${content}</div>
					</li>
				`;
			}).join('');

		} catch (err) {
			listEl.innerHTML = `<li class="error">加载失败: ${err.message}</li>`;
		}
	}

	// 页面加载完成后执行
	loadShuoshuo();
</script>
